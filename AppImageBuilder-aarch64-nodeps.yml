# System dependencies for building (Raspberry Pi OS aarch64):
#
# *** First boot after installation ***
# ** Run through the 1st boot prompts in GUI **
# sudo apt update && sudo apt upgrade -y
# sudo reboot
# 
# *** Building an AppImage - Mostly automated instructions ***
# ./build.sh
#
# *** Building an AppImage - Manual instructions ***
#
# export LATEST_VERSION="version_2.4.1" 
# cp AppImageBuilder-aarch64-minimal.yml AppImageBuilder-aarch64-minimal-${LATEST_VERSION}.yml
# sed -i "s#%%VERSION%%#${LATEST_VERSION}#g" AppImageBuilder-aarch64-minimal-${LATEST_VERSION}.yml
# sudo apt install -y libgl1-mesa-dev libglu1-mesa-dev build-essential cmake python3-pip python3-setuptools patchelf desktop-file-utils libgdk-pixbuf2.0-dev fakeroot strace fuse libgtk-3-dev m4 zstd screen
# sudo wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage -O /usr/local/bin/appimagetool
# sudo chmod +x /usr/local/bin/appimagetool
# sudo pip3 install appimage-builder
# screen
# appimage-builder --recipe AppImageBuilder-aarch64-minimal-${LATEST_VERSION}.yml
#
version: 1

script: |
  [[ -d "./PrusaSlicer" ]] || git clone https://github.com/prusa3d/PrusaSlicer --single-branch --branch %%VERSION%% --depth 1 PrusaSlicer && \
  cd PrusaSlicer/deps && \
  mkdir -p build && \
  cd build && \
  cmake .. -DDEP_WX_GTK3=ON && \
  cmake --build . && \
  cd ../.. && \
  mkdir -p build && \
  cd build && \
  rm -rf AppDir && \
  cmake .. \
  -GNinja \
  -DCMAKE_INSTALL_PREFIX=/usr \
  -DCMAKE_PREFIX_PATH=$(pwd)/../deps/build/destdir/usr/local \
  -DSLIC3R_PCH=OFF \
  -DSLIC3R_STATIC=ON \
  -DSLIC3R_WX_STABLE=OFF \
  -DSLIC3R_GTK=3 \
  -DCMAKE_BUILD_TYPE=Release && \
  DESTDIR=AppDir cmake --build ./ --target install -j $(nproc) && \
  mkdir -p AppDir/usr/share/icons && \
  cp AppDir/usr/resources/icons/PrusaSlicer.svg ./AppDir/usr/share/icons

AppDir:
  path: ./PrusaSlicer/build/AppDir
  app_info:
    id: com.prusa3d.PrusaSlicer
    name: PrusaSlicer
    icon: PrusaSlicer
    version: %%VERSION%%
    exec: usr/bin/prusa-slicer
    exec_args: $@

AppImage:
  arch: aarch64
  update-information: guess

